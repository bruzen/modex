<html>
<head>

<script language="javascript" src="jquery.min.js"></script>
<script language="javascript" src="json2.js"></script>
<script>
global = this;
$(function() {

username = "McSkills"+Math.floor(Math.random()*222)

status = $("#status")
chatwindow = $("#chatwindow")
chatwindow.backlog = 30;
inputbox = $("#inputbox")

chatwindow.chatlines = Array(chatwindow.backlog)


channel = WebSocket("ws://localhost:8080/chatrooms/ireland/")
channel.onopen = function(evt) {
  console.log("channel open;", evt);
  channel.send(JSON.stringify({username: "", message: username + " has entered the channel."}))
}

channel.onmessage = function(evt) {
 data = JSON.parse(evt.data)
 recvchat(data['username'], data['message'])
}

function recvchat(username, message) {
  chatwindow.chatlines.push(username + ": " + message);
  if(chatwindow.chatlines.length > chatwindow.chatlines.backlog) {
    chatwindow.chatlines.shift() //keep scrollback buffer a constant size
  }
  chatwindow.val(chatwindow.chatlines.join("\n"))
  chatwindow.scroll().scrollTop(chatwindow.height() + 500) //weird invocation....
}

function sendchat() {
  channel.send(JSON.stringify({username: username, message: inputbox.val()}))
  inputbox.val(null);
}

inputbox.keydown(function(evt) {
  if(evt.which == 13) { //return key
    sendchat()
  }
})

global.inputbox = inputbox;
global.channel = channel;

})
</script>

<style>

#chatwindow {
  width: 100%;
  height: 18em;
  display: block;
  text-align: right;
}

#inputbox {
  display: inline-block;
}
#inputwrapper {
  display: block;
  float: right;
}

</style>

</head>
<body>

<h2>Avast! Ireland Chat</h2>
<form onsubmit="return false;">
<textarea id="chatwindow" rows=18 cols=80>

</textarea>
<div id="inputwrapper">
 <input type="text" id="inputbox"></input>
 <input type="button" id="send" value="send"></input>
</div>
</form>

</body>
</html>
