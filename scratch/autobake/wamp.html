<html>

<head>
 <title>Experimental WAMP.ws code</title>
 <script type="text/javascript" src="autobahn.js"></script>
 <script type="text/javascript">
  var global = this;
  window.onload = function() {  //demo code from https://github.com/tavendo/AutobahnJS
    // careful: using var makes a local that shadows the global autobahn (python scoping rules)
  console.log("loading");
  autobahn._debugpubsub = true;

var connection = new autobahn.Connection({
   url: 'ws://127.0.0.1:9000/',
   realm: 'realm1'});

connection.onopen = function (session) {
   console.log("opening session:");
   console.log(session)
   

   //pubsub handlers can either take no args (JS just ignores extra args)
   function heartbeatHandler() { 
     console.log("heartbeat");
   }

   //or args and kwargs (python-style, matching the args and kwargs passed from the python server side)
   function dataHandler(args,kwargs) { 
     console.log("got data: " + "args = " + JSON.stringify(args) + ", kwargs = " + JSON.stringify(kwargs))
   }

   // or an additional "EventDetails" object which gives connection metadata
   function metaLooker(args, kwargs, evtDetails) { 
     console.log("metadata details: " + JSON.stringify(evtDetails))
   }

   session.subscribe(heartbeatHandler, "lovetriangle");
   session.subscribe(metaLooker, "lovetriangle");
   session.subscribe(dataHandler, "haterhombus");
  
  console.log(connection._websocket.readyState);
  global.session = session; //stash for debugging
}



global.connection = connection; //stash for debugging

connection.open();
console.log(connection._websocket.readyState);

connection._websocket.onerror = function(evt) {
  console.log("websocket error: " + evt.reason)
  console.log(evt)
}

connection._websocket.onclose = function(evt) {
  console.log("websocket close: " + evt.reason)
  console.log(evt)
}

console.log(connection._websocket.readyState);
}

</script>



</head>
<body>

<h1>WAMP with AutobahnJS and AutobahnPython</h1>

Run server.py (found in the same folder), open up the web inspector to the JS console, and reload this page.

<h2>Known Bugs</h2>
The API versions are inconsistent amongst the varieties of Autobahn, so there's some issues to work through.
<ol>
<li>heartbeatHandler() is crashing and I don't know why; maybe because it's not getting an argument?</li>
<li>The data that is passed through to dataHandler() is only the first element in the list of args, though the server appears to be formatting it as if it knows what it's doing (e.g. 
 <code><pre>
2014-02-12 21:19:02-0500 [-] TX Frame to 127.0.0.1:60876 : fin = True, rsv = 0, opcode = 1, mask = -, length = 95, repeat_length = None, chopsize = None, sync = False, payload = [36,6491576786669246,6795983798931556,{},[69,23],{"c":"Hello","d":{"counter":9,"foo":[1,2,3]}}]
</pre></code></li>
</ol>

</body>
</html>
